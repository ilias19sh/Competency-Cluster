name: CI / SonarCloud

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    name: Build, Test & Sonar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests and generate coverage
        run: npm run test -- --coverage --watchAll=false || echo "No tests found"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  update-pr-description:
    name: Update PR Header
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Add Preview Link to PR Body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const branch = pr.head.ref.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const url = `https://competency-cluster-git-${branch}-cc-cda.vercel.app`;
            
            const header = `### üöÄ Preview Deployment\n**Link:** [${url}](${url})\n\n---\n`;
            
            // On v√©rifie si le lien est d√©j√† pr√©sent pour √©viter de le dupliquer √† chaque commit
            if (!pr.body || !pr.body.includes(url)) {
              const newBody = header + (pr.body || "");
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: newBody
              });
            }